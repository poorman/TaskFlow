# Traefik Setup for admin.widesurf.com

## Overview

TaskFlow is configured to work with Traefik reverse proxy for SSL termination and routing. The application is accessible at **https://admin.widesurf.com**.

## Configuration Summary

### Domain Routing

- **Frontend**: `https://admin.widesurf.com` → TaskFlow frontend (port 3014)
- **Backend API**: `https://admin.widesurf.com/api/*` → TaskFlow backend (port 8000)
- **API Docs**: `https://admin.widesurf.com/docs` → FastAPI Swagger UI

### SSL Certificates

- Automatically generated by Traefik using Let's Encrypt
- Certificates are stored in `/home/pbieda/scripts/pbieda-portfolio/traefik/acme.json`
- HTTP to HTTPS redirect is configured automatically

## Network Configuration

TaskFlow services are connected to:
- `taskflow-network`: Internal network for TaskFlow services
- `traefik-proxy`: External network to communicate with Traefik

The `traefik-proxy` network is shared with the main Traefik container in `pbieda-portfolio`.

## Traefik Labels

### Frontend Labels
```yaml
- "traefik.http.routers.taskflow-frontend.rule=Host(`admin.widesurf.com`) && !(PathPrefix(`/api`) || PathPrefix(`/docs`) || PathPrefix(`/redoc`))"
- "traefik.http.routers.taskflow-frontend.entrypoints=websecure"
- "traefik.http.routers.taskflow-frontend.tls=true"
- "traefik.http.routers.taskflow-frontend.tls.certresolver=le"
```

### Backend Labels
```yaml
- "traefik.http.routers.taskflow-backend.rule=Host(`admin.widesurf.com`) && (PathPrefix(`/api`) || PathPrefix(`/docs`) || PathPrefix(`/redoc`))"
- "traefik.http.routers.taskflow-backend.entrypoints=websecure"
- "traefik.http.routers.taskflow-backend.tls=true"
- "traefik.http.routers.taskflow-backend.tls.certresolver=le"
```

## Prerequisites

1. Traefik container running in `pbieda-portfolio`
2. Domain `admin.widesurf.com` DNS pointing to your server
3. Traefik network `pbieda-portfolio_traefik-proxy` exists

## Deployment Steps

### 1. Ensure Traefik is Running

```bash
cd /home/pbieda/scripts/pbieda-portfolio
docker-compose ps traefik
```

If not running:
```bash
docker-compose up -d traefik
```

### 2. Verify Network Exists

```bash
docker network ls | grep traefik-proxy
```

If network doesn't exist, create it:
```bash
docker network create traefik-proxy
```

### 3. Start TaskFlow Services

```bash
cd /home/pbieda/scripts/taskflow
docker-compose up -d --build
```

### 4. Initialize Database

```bash
docker-compose exec backend python init_db.py
```

### 5. Verify SSL Certificate Generation

Check Traefik logs for certificate generation:
```bash
docker logs traefik | grep "admin.widesurf.com"
```

You should see:
```
Certificate obtained for domains admin.widesurf.com
```

### 6. Test Access

- Frontend: https://admin.widesurf.com
- API Docs: https://admin.widesurf.com/docs
- Health Check: https://admin.widesurf.com/api/v1/health

## Troubleshooting

### SSL Certificate Not Generated

1. Check DNS:
   ```bash
   dig admin.widesurf.com
   # Should point to your server IP
   ```

2. Check Traefik logs:
   ```bash
   docker logs traefik
   ```

3. Verify acme.json permissions:
   ```bash
   ls -la /home/pbieda/scripts/pbieda-portfolio/traefik/acme.json
   # Should be readable by Traefik container
   ```

### Services Not Accessible

1. Check if services are running:
   ```bash
   docker-compose ps
   ```

2. Check network connectivity:
   ```bash
   docker network inspect pbieda-portfolio_traefik-proxy
   ```

3. Verify Traefik labels:
   ```bash
   docker inspect taskflow-frontend | grep -A 20 Labels
   docker inspect taskflow-backend | grep -A 20 Labels
   ```

### CORS Errors

Update CORS_ORIGINS in backend environment to include:
```
https://admin.widesurf.com
```

## Network Architecture

```
Internet
   │
   ▼
Traefik (ports 80, 443)
   │
   ├─── admin.widesurf.com/ → taskflow-frontend:3014
   │
   └─── admin.widesurf.com/api/* → taskflow-backend:8000
```

## Environment Variables

Ensure these are set correctly:

### Frontend
```bash
NEXT_PUBLIC_API_URL=https://admin.widesurf.com
```

### Backend
```bash
CORS_ORIGINS=https://admin.widesurf.com
GOOGLE_REDIRECT_URI=https://admin.widesurf.com/api/v1/auth/google/callback
```

## Monitoring

### Check Service Status
```bash
docker-compose ps
```

### View Logs
```bash
docker-compose logs -f frontend
docker-compose logs -f backend
docker logs traefik
```

### Test HTTPS
```bash
curl -I https://admin.widesurf.com
```

Should return:
```
HTTP/2 200
```

## Security Notes

- All HTTP traffic is automatically redirected to HTTPS
- SSL certificates are auto-renewed by Traefik
- Certificates use Let's Encrypt ACME protocol
- Communication between services uses internal Docker networks

